// Copyright Â© 2016, Peter Atashian

use std::ops::{Add, AddAssign, Div, Mul, Sub};

#[derive(Clone, Copy, Debug)]
pub struct Pixel(f32, f32, f32);
impl Pixel {
    pub fn black() -> Pixel { Pixel(0., 0., 0.) }
    pub fn from_srgb(r: u8, g: u8, b: u8) -> Pixel {
        let r = SRGB_TO_LINEAR[r as usize];
        let g = SRGB_TO_LINEAR[g as usize];
        let b = SRGB_TO_LINEAR[b as usize];
        Pixel(r, g, b)
    }
    pub fn diff_sq(self, o: Pixel) -> f32 {
        let d = self - o;
        0.299 * d.0 * d.0 + 0.587 * d.1 * d.1 + 0.114 * d.2 * d.2
    }
}
impl Add<Pixel> for Pixel {
    type Output = Pixel;
    fn add(self, o: Pixel) -> Pixel {
        Pixel(self.0 + o.0, self.1 + o.1, self.2 + o.2)
    }
}
impl AddAssign<Pixel> for Pixel {
    fn add_assign(&mut self, o: Pixel) {
        self.0 += o.0;
        self.1 += o.1;
        self.2 += o.2;
    }
}
impl Div<f32> for Pixel {
    type Output = Pixel;
    fn div(self, o: f32) -> Pixel {
        Pixel(self.0 / o, self.1 / o, self.2 / o)
    }
}
impl Mul<f32> for Pixel {
    type Output = Pixel;
    fn mul(self, o: f32) -> Pixel {
        Pixel(self.0 * o, self.1 * o, self.2 * o)
    }
}
impl Sub<Pixel> for Pixel {
    type Output = Pixel;
    fn sub(self, o: Pixel) -> Pixel {
        Pixel(self.0 - o.0, self.1 - o.1, self.2 - o.2)
    }
}
const SRGB_TO_LINEAR: &'static [f32; 256] = &[
    0.0000000000e0, 3.0352698355e-4, 6.0705396710e-4, 9.1058095065e-4, 1.2141079342e-3,
    1.5176349177e-3, 1.8211619013e-3, 2.1246888848e-3, 2.4282158684e-3, 2.7317428519e-3,
    3.0352698355e-3, 3.3465357639e-3, 3.6765073240e-3, 4.0247170185e-3, 4.3914420374e-3,
    4.7769534807e-3, 5.1815167023e-3, 5.6053916242e-3, 6.0488330229e-3, 6.5120907926e-3,
    6.9954101873e-3, 7.4990320432e-3, 8.0231929854e-3, 8.5681256181e-3, 9.1340587022e-3,
    9.7212173202e-3, 1.0329823030e-2, 1.0960094006e-2, 1.1612245180e-2, 1.2286488357e-2,
    1.2983032342e-2, 1.3702083047e-2, 1.4443843596e-2, 1.5208514423e-2, 1.5996293366e-2,
    1.6807375753e-2, 1.7641954488e-2, 1.8500220128e-2, 1.9382360957e-2, 2.0288563057e-2,
    2.1219010376e-2, 2.2173884793e-2, 2.3153366178e-2, 2.4157632449e-2, 2.5186859627e-2,
    2.6241221895e-2, 2.7320891639e-2, 2.8426039504e-2, 2.9556834438e-2, 3.0713443733e-2,
    3.1896033073e-2, 3.3104766571e-2, 3.4339806809e-2, 3.5601314875e-2, 3.6889450401e-2,
    3.8204371595e-2, 3.9546235277e-2, 4.0915196907e-2, 4.2311410621e-2, 4.3735029257e-2,
    4.5186204386e-2, 4.6665086337e-2, 4.8171824227e-2, 4.9706565984e-2, 5.1269458374e-2,
    5.2860647023e-2, 5.4480276442e-2, 5.6128490050e-2, 5.7805430191e-2, 5.9511238163e-2,
    6.1246054232e-2, 6.3010017653e-2, 6.4803266693e-2, 6.6625938644e-2, 6.8478169844e-2,
    7.0360095697e-2, 7.2271850682e-2, 7.4213568380e-2, 7.6185381481e-2, 7.8187421805e-2,
    8.0219820314e-2, 8.2282707130e-2, 8.4376211544e-2, 8.6500462037e-2, 8.8655586286e-2,
    9.0841711183e-2, 9.3058962847e-2, 9.5307466631e-2, 9.7587347142e-2, 9.9898728247e-2,
    1.0224173309e-1, 1.0461648409e-1, 1.0702310298e-1, 1.0946171078e-1, 1.1193242784e-1,
    1.1443537383e-1, 1.1697066776e-1, 1.1953842799e-1, 1.2213877223e-1, 1.2477181756e-1,
    1.2743768044e-1, 1.3013647669e-1, 1.3286832155e-1, 1.3563332966e-1, 1.3843161503e-1,
    1.4126329114e-1, 1.4412847086e-1, 1.4702726650e-1, 1.4995978981e-1, 1.5292615200e-1,
    1.5592646371e-1, 1.5896083506e-1, 1.6202937564e-1, 1.6513219450e-1, 1.6826940019e-1,
    1.7144110073e-1, 1.7464740366e-1, 1.7788841598e-1, 1.8116424425e-1, 1.8447499450e-1,
    1.8782077230e-1, 1.9120168274e-1, 1.9461783044e-1, 1.9806931956e-1, 2.0155625379e-1,
    2.0507873639e-1, 2.0863687015e-1, 2.1223075741e-1, 2.1586050011e-1, 2.1952619973e-1,
    2.2322795732e-1, 2.2696587351e-1, 2.3074004852e-1, 2.3455058216e-1, 2.3839757381e-1,
    2.4228112247e-1, 2.4620132671e-1, 2.5015828473e-1, 2.5415209433e-1, 2.5818285292e-1,
    2.6225065753e-1, 2.6635560480e-1, 2.7049779101e-1, 2.7467731206e-1, 2.7889426348e-1,
    2.8314874043e-1, 2.8744083773e-1, 2.9177064982e-1, 2.9613827080e-1, 3.0054379442e-1,
    3.0498731407e-1, 3.0946892282e-1, 3.1398871338e-1, 3.1854677813e-1, 3.2314320911e-1,
    3.2777809806e-1, 3.3245153635e-1, 3.3716361505e-1, 3.4191442491e-1, 3.4670405636e-1,
    3.5153259950e-1, 3.5640014415e-1, 3.6130677978e-1, 3.6625259560e-1, 3.7123768047e-1,
    3.7626212299e-1, 3.8132601143e-1, 3.8642943379e-1, 3.9157247775e-1, 3.9675523073e-1,
    4.0197777983e-1, 4.0724021190e-1, 4.1254261348e-1, 4.1788507085e-1, 4.2326766999e-1,
    4.2869049661e-1, 4.3415363617e-1, 4.3965717384e-1, 4.4520119452e-1, 4.5078578284e-1,
    4.5641102318e-1, 4.6207699965e-1, 4.6778379611e-1, 4.7353149615e-1, 4.7932018310e-1,
    4.8514994006e-1, 4.9102084985e-1, 4.9693299506e-1, 5.0288645803e-1, 5.0888132085e-1,
    5.1491766538e-1, 5.2099557320e-1, 5.2711512571e-1, 5.3327640401e-1, 5.3947948901e-1,
    5.4572446137e-1, 5.5201140151e-1, 5.5834038963e-1, 5.6471150570e-1, 5.7112482946e-1,
    5.7758044043e-1, 5.8407841789e-1, 5.9061884092e-1, 5.9720178836e-1, 6.0382733886e-1,
    6.1049557081e-1, 6.1720656242e-1, 6.2396039168e-1, 6.3075713635e-1, 6.3759687399e-1,
    6.4447968197e-1, 6.5140563742e-1, 6.5837481728e-1, 6.6538729828e-1, 6.7244315696e-1,
    6.7954246963e-1, 6.8668531244e-1, 6.9387176129e-1, 7.0110189193e-1, 7.0837577989e-1,
    7.1569350051e-1, 7.2305512892e-1, 7.3046074009e-1, 7.3791040877e-1, 7.4540420954e-1,
    7.5294221678e-1, 7.6052450468e-1, 7.6815114725e-1, 7.7582221832e-1, 7.8353779153e-1,
    7.9129794033e-1, 7.9910273801e-1, 8.0695225767e-1, 8.1484657222e-1, 8.2278575440e-1,
    8.3076987677e-1, 8.3879901174e-1, 8.4687323151e-1, 8.5499260812e-1, 8.6315721345e-1,
    8.7136711920e-1, 8.7962239689e-1, 8.8792311788e-1, 8.9626935337e-1, 9.0466117439e-1,
    9.1309865179e-1, 9.2158185628e-1, 9.3011085838e-1, 9.3868572846e-1, 9.4730653673e-1,
    9.5597335325e-1, 9.6468624789e-1, 9.7344529040e-1, 9.8225055033e-1, 9.9110209711e-1,
    1.0000000000e0,
];
